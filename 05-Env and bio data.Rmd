---
title: "es analysis of env on bio"
author: "Stephen Noell"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE,
                      fig.align = "center",
                      fig.width = 10,
                      fig.height = 6)
```


```{r Libraries and seed}

# Libraries
library("tidyverse")       # data wrangling and visualisation
library("phyloseq")        # analysis of microbial communities
library("vegan")           # ecological multivariate analyses
library("patchwork")       # plots together
library("pairwiseAdonis")
library("microbiome") #for analyzing phyloseq objects
library("viridis") #color package
library("svglite") #for saving SVGs
library("ggpubr") #for saving plots
library("here")            # set the path to the folder 
library("ggrepel")
library("microeco")
library("file2meco") #for converting phyloseq to microeco
#library("mice")
#library("microViz")

set.seed(57)
```


```{r}
############ load data
esfclr <- readRDS("physeq.es.clr")
esfa <- readRDS("physeq.es.rel")
envdata <-  read.csv("sample_data.csv", header = TRUE) %>%
  column_to_rownames(., var = "Sample")

#transform phyloseq to microeco object
esfa_meco <- phyloseq2meco(esfa)
esfa_meco$tax_table <- tidy_taxonomy(esfa_meco$tax_table)
esfa_meco$sample_table <- data.frame(envdata)

esfclr_meco <- phyloseq2meco(esfclr)
esfclr_meco$tax_table <- tidy_taxonomy(esfclr_meco$tax_table)
esfclr_meco$sample_table <- data.frame(envdata)

t1 <- trans_env$new(dataset = esfa_meco, env_cols = c(6:9))
t1$cal_autocor()

t2 <- trans_env$new(dataset = esfclr_meco, env_cols = c(6:9))
```

```{r}
#Look for correlations between environmental factors using more robust method
env <- envdata[6:9]
numeric_columns <- env[sapply(env, is.numeric)]

# Create an empty list to store results
correlation_results <- list()

# Loop through each pair of numerical columns
for (i in 1:(ncol(numeric_columns) - 1)) {
  for (j in (i + 1):ncol(numeric_columns)) {
    # Calculate correlation test
    corr_test <- cor.test(numeric_columns[, i], numeric_columns[, j], method = "spearman")
    
    # Store results in a list
    correlation_results <- c(correlation_results, list(
      c(colnames(numeric_columns)[i], colnames(numeric_columns)[j], corr_test$estimate, corr_test$p.value)
    ))
  }
}

# Convert the list to a data frame
correlation_df <- as.data.frame(do.call(rbind, correlation_results))
colnames(correlation_df) <- c("Variable_1", "Variable_2", "Correlation_Coefficient", "P_Value")

# Perform Benjamini-Hochberg adjustment
correlation_df$Adjusted_P_Value <- p.adjust(correlation_df$P_Value, method = "BH")
correlation_df2 <- correlation_df %>%
  dplyr::mutate(significance = case_when(
    Adjusted_P_Value < 0.001 ~ "***",
    Adjusted_P_Value < 0.01 ~ "**",
    Adjusted_P_Value < 0.05 ~ "*",
    TRUE ~ ""
  ))

correlation_df2
#write.csv(correlation_df2, "Table S3.csv")
```


```{r}
# initial dbRDA with all factors
t1$cal_ordination(method = "dbRDA", use_measure = "bray")
t1$trans_ordination(adjust_arrow_length = TRUE, max_perc_env = 1.5)
t1$plot_ordination(plot_color = "Ice.thickness", plot_shape = "Ice.thickness", 
                   shape_values = c(16, 15, 18, 17),  color_values = c("#addd8e", "#41b6c4", "#225ea8", "#081d58"))

#Mantel test for correlations betw env parameters and microbial community, determine which factors are significant
t1$cal_mantel(use_measure = "bray")
sig_facs <- t1$res_mantel %>%
  dplyr::filter(., p.value < 0.05)

sig_facs

#all are significant in this case; Conductivity has strongest correlation coefficient of 0.38

dbrda_plot_f <- t1$plot_ordination(plot_color = "Depth.bin", plot_shape = "Ice.thickness", 
                   shape_values = c(16, 15, 18, 17),  color_values = c("#542788", "#e08214"))
dbrda_plot_f
```



```{r}
t1$cal_ordination(method = "RDA", taxa_level = "Phylum")
# As the main results of RDA are related with the projection and angles between different arrows,
# we adjust the length of the arrow to show them clearly using several parameters.

t1$res_ordination_R2
#0.25 for adjusted R2 value

t1$trans_ordination(show_taxa = 5, adjust_arrow_length = TRUE, max_perc_env = 1, max_perc_tax = 1, min_perc_env = 0.2, min_perc_tax = 0.2)

t1$res_ordination_trans
# t1$res_rda_trans is the transformed result for plotting
rda_plot <- t1$plot_ordination(plot_color = "Ice.thickness", plot_shape = "Ice.thickness", 
                   shape_values = c(16, 15, 18, 17),  color_values = c("#addd8e", "#41b6c4", "#225ea8", "#081d58")) 

rda_plot
```

```{r}
#correlation between taxa and env parameters
t1$cal_cor(use_data = "Genus", p_adjust_method = "fdr", p_adjust_type = "Env")
cor_genus <- t1$plot_cor(filter_feature = c(c("", "*")))


t1$cal_cor(use_data = "Phylum", p_adjust_method = "fdr", p_adjust_type = "Env")
cor_phy <- t1$plot_cor(filter_feature = c(""))
```

```{r}
# Final plot!
rda_plots <- ggarrange(dbrda_plot_f, rda_plot,
                       nrow = 2,
                       labels = c("A", "B"))

rda_plots 


#ggsave("Figure4.png", rda_plots, width = 200, height = 220, units = "mm", dpi = 300)
#ggsave("Figure4.svg", rda_plots, width = 200, height = 220, units = "mm", dpi = 300)

#Correlations
cor_heats <- ggarrange(cor_phy, cor_genus,
                       nrow = 2,
                       labels = c("A", "B"),
                       heights = c(0.65, 1))

cor_heats 

#ggsave("Figure5.png", cor_heats, width = 200, height = 200, units = "mm", dpi = 300)
#ggsave("Figure5.svg", cor_heats, width = 200, height = 200, units = "mm", dpi = 300)
```